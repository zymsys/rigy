# Draft Spec: `--emit-expanded-yaml`

## Goal

Make preprocessing outcomes visible and auditable before render/export, so users can debug macro expansion and transform normalization quickly.

## Command surface

Primary form:

```bash
rigy compile <input.rigy.yaml> -o <output.glb> --emit-expanded-yaml <expanded.rigy.yaml>
```

Optional stdout form:

```bash
rigy compile <input.rigy.yaml> -o <output.glb> --emit-expanded-yaml -
```

## Behavior

When `--emit-expanded-yaml` is present, compiler MUST write the post-preprocessing document used for parse/validate/export.

The emitted document MUST contain:
- no `repeat` blocks
- no `params`
- no unresolved `${...}` or `$param`
- no `aabb` (converted to `dimensions` + `transform.translation`)
- no `box_decompose` macro items (expanded into primitives)
- normalized transform rotation field (if `rotation_degrees` was authored, emit canonical `rotation_euler`)

## Determinism requirements

- Emitting expanded YAML MUST NOT change GLB output bytes.
- Expanded YAML serialization should be stable for a given input + spec version.
- Key order should follow canonical field order where possible (matching schema order).

## Error behavior

- If compile fails before preprocessing completion, expanded YAML is not emitted.
- If preprocessing succeeds but semantic validation fails, expanded YAML MAY still be emitted with `--emit-on-error` (optional extension).

## Suggested optional flags

- `--emit-expanded-yaml-format {yaml,json}` (default yaml)
- `--emit-on-error` (emit expanded doc even when later validation fails)

## Why this helps

For house-like models, this immediately exposes:
- exact primitives generated by `box_decompose`
- final centered dimensions from `aabb`
- normalized rotations used by tessellation

It turns many visual debugging loops into quick text inspection.
