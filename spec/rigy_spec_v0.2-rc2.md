# Rigy — RigSpec YAML (v0.2-rc2)

**Pronunciation**
- **Rigy**: “RIG-ee”
- **Ricy** (RigSpec Contract YAML): “RYE-see”
- **Rigs** (RigSpec Scene / Layout): “RIGS”

Rigy is a **text-based specification language for rigged assemblies of geometric primitives**.
It enables deterministic, tool-friendly construction of reusable 3D assets that compile to
standard formats such as **glTF** and **FBX**.

Rigy v0.2 introduces **composition**: assets may import other assets and attach them together
using explicitly defined anchor frames.

---

## Design Principles

- **Deterministic by construction**
- **Declarative, not procedural**
- **Asset-first**
- **Composable via explicit interfaces**

---

## Scope of v0.2

Rigy v0.2 supports:
- Geometric primitives
- Armatures (bones)
- Per-primitive skinning
- Asset imports
- Anchor-based attachment (`attach3`)
- Minimal contracts (Ricy)

Rigy v0.2 intentionally does **not** support:
- Animation curves
- Constraints or IK
- Arbitrary mesh deformation
- Scene layout (handled by **Rigs**)

---

## Coordinate System & Units

Rigy uses a canonical coordinate system aligned with **glTF 2.0**.

```yaml
units: meters
coordinate_system:
  up: Y
  forward: -Z
  handedness: right
```

All coordinates in the specification are expressed in this frame.

---

## Asset Space (Normative)

Every Rigy asset defines a single **asset-local coordinate space**.

**Asset space is defined as:**
- the local space of the asset root
- if an armature exists, the armature root defines asset space
- otherwise, the implicit asset origin defines asset space

This definition guarantees that all spatial references within an asset are interpreted
consistently, regardless of internal structure.

---

## Anchors (Normative)

Anchors define stable interface points for composition.

All anchors are expressed in **asset-local space** and are independent of meshes and bones.
They do not inherit transforms from subcomponents.

```yaml
anchors:
  - id: mount_a
    translation: [0, 0, 0]
```

### Optional anchor annotation (Non-Normative)

```yaml
anchors:
  - id: door_mount_L
    translation: [1.2, 0.8, 0.4]
    scope: left_door
```

- `scope` is informational only
- It MUST NOT affect mathematical interpretation or attachment behavior

---

## Meshes

Meshes define collections of geometric primitives merged into a single mesh.

Supported primitives:
- `box`
- `sphere`
- `capsule`
- `cylinder`

Primitive transforms are applied **before** mesh merge.

---

## Armatures

Armatures define bone hierarchies used for articulation.

- `parent: none` designates a root bone
- `head` / `tail` are armature-local coordinates
- `roll` is expressed in radians
- Bone hierarchies MUST be acyclic
- Zero-length bones are invalid

---

## Skinning Model

Skinning is **per-primitive**.

- All vertices generated by a primitive receive identical weights
- Weights MUST be in `[0.0, 1.0]`
- Weights are normalized per primitive before export

This model supports articulated rigid and semi-rigid assemblies.

---

## Imports

Assets may import other Rigy assets for composition.

```yaml
imports:
  wheel:
    source: parts/wheel.rigy.yaml
    contract: parts/wheel.ricy.yaml
```

- Each import introduces a namespace (`wheel.*`)
- Imported assets are immutable
- If a contract is specified, the compiler **MUST** validate the imported asset against it

---

## Instances

Instances place local meshes or imported assets into the current asset.

```yaml
instances:
  - id: wheel_fl
    import: wheel
    attach3: ...
```

Instances form a flat list. Hierarchical layout is handled by **Rigs**, not Rigy.

---

## attach3 — Anchor-Based Attachment (Normative)

`attach3` attaches an imported asset instance to the current asset using two anchor frames.

```yaml
attach3:
  from: [wheel.mount_a, wheel.mount_b, wheel.mount_c]
  to:   [fl_a, fl_b, fl_c]
  mode: affine
```

### Frame3 Construction

Given three anchors `[p1, p2, p3]`:

- `p1` = origin
- `x̂ = normalize(p2 − p1)`
- `t = (p3 − p1)`
- `ẑ = normalize(x̂ × t)` (right-handed)
- `ŷ = ẑ × x̂`

**Constraints**
- Points MUST be non-collinear
- `distance(p1,p2) > ε`
- `|x̂ × t| > ε`

Violation of these constraints MUST cause a compile-time error.

---

## Attachment Modes

`mode` is **required**.

| Mode     | Description |
|----------|-------------|
| `rigid`  | Translation + rotation |
| `uniform` | Translation + rotation + uniform scale |
| `affine` | Full affine transform (may include non-uniform scale and shear) |

---

## Transform Application

The transform computed by `attach3` MUST be applied as a **node transform** on the imported
asset instance.

Compilers MAY optionally bake transforms into geometry and bones for compatibility or
optimization purposes.

---

## Contracts (Ricy)

Contracts define the public interface of an asset.

```yaml
contract_version: "0.1"

required_anchors:
  - mount_a
  - mount_b
  - mount_c

required_frame3_sets:
  - mount

frame3_sets:
  mount: [mount_a, mount_b, mount_c]
```

Contracts:
- define interface shape
- enable validation and tooling
- MUST NOT introduce behavioral logic

---

## Validation Rules (Selected)

A compiler MUST fail if:

- Anchor references are undefined
- Frame3 constraints are violated
- `attach3.mode` is missing
- Imported contracts are violated
- IDs collide after namespace resolution

---

## Relationship to Rigs (Non-Normative)

Rigy defines **assets**.

Rigs (`*.rigs.yaml`) defines **layout and scene composition**, including:
- placement slots
- nudging
- rotation presets
- hierarchical scene trees

Rigy remains intentionally strict and asset-focused.

---

## Roadmap

### v0.3
- Region-based primitive weighting
- Vertex-level skinning

### v1.0
- Animation
- Constraints
- Physics
